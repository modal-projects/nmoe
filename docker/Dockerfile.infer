# Inference image - extends deps with DeepEP, DeepGEMM, full FlashMLA, nixl
FROM xjdr/nmoe:deps

# Additional system deps for RDMA/inference
RUN apt-get update && apt-get install -y \
    libibverbs-dev \
    librdmacm-dev \
    libnuma-dev \
    && rm -rf /var/lib/apt/lists/*

# Additional Python deps for inference
RUN uv pip install safetensors packaging "nixl[cu12]"

# Replace pruned FlashMLA with full version (inference needs sparse kernels)
RUN rm -rf third_party/flashmla && \
    git clone https://github.com/deepseek-ai/FlashMLA.git third_party/flashmla && \
    cd third_party/flashmla && \
    git checkout 1408756a88e52a25196b759eaf8db89d2b51b5a1 && \
    git submodule update --init --recursive && \
    rm -rf .git && \
    find . -name .git -o -name .gitmodules -exec rm -rf {} + && \
    echo "✓ Cloned FlashMLA (full)"

# Build FlashMLA (SM100 sparse kernels)
RUN cd third_party/flashmla && \
    . /workspace/nmoe/.venv/bin/activate && \
    FLASH_MLA_DISABLE_SM90=1 \
    python setup.py build_ext --inplace && \
    echo "✓ Built FlashMLA"

# Clone and build DeepEP (intranode only, no NVSHMEM)
RUN git clone https://github.com/deepseek-ai/DeepEP.git third_party/DeepEP && \
    cd third_party/DeepEP && \
    git submodule update --init --recursive && \
    rm -rf .git && \
    find . -name .git -o -name .gitmodules -exec rm -rf {} + && \
    . /workspace/nmoe/.venv/bin/activate && \
    python setup.py build_ext --inplace && \
    echo "✓ Built DeepEP"

# Clone and build DeepGEMM
RUN git clone https://github.com/deepseek-ai/DeepGEMM.git third_party/DeepGEMM && \
    cd third_party/DeepGEMM && \
    git submodule update --init --recursive && \
    rm -rf .git && \
    find . -name .git -o -name .gitmodules -exec rm -rf {} + && \
    # DeepGEMM JIT compiles with `-I deep_gemm/include` and includes `<cute/...>` / `<cutlass/...>`.
    # Wire in submodule headers so NVCC JIT compilation succeeds in the container.
    rm -rf deep_gemm/include/cute deep_gemm/include/cutlass && \
    ln -s /workspace/nmoe/third_party/DeepGEMM/third-party/cutlass/include/cute deep_gemm/include/cute && \
    ln -s /workspace/nmoe/third_party/DeepGEMM/third-party/cutlass/include/cutlass deep_gemm/include/cutlass && \
    test -f deep_gemm/include/cute/container/tuple.hpp && \
    . /workspace/nmoe/.venv/bin/activate && \
    python setup.py build_ext --inplace && \
    echo "✓ Built DeepGEMM"

# NCCL settings
ENV NCCL_DEBUG=WARN
ENV NCCL_IB_DISABLE=1
ENV NCCL_P2P_DISABLE=0
ENV NCCL_P2P_LEVEL=NVL
ENV NCCL_SHM_DISABLE=0
ENV CUDA_DEVICE_MAX_CONNECTIONS=1

# Copy source
COPY . /workspace/nmoe

# Build nmoe kernels
RUN . .venv/bin/activate && make -C nmoe/csrc

# Python path (add inference deps)
ENV PYTHONPATH=/workspace/nmoe:/workspace/nmoe/nmoe/csrc:/workspace/nmoe/third_party:/workspace/nmoe/third_party/DeepEP:/workspace/nmoe/third_party/DeepGEMM:/workspace/nmoe/third_party/flashmla:/workspace/nmoe/triton/python
